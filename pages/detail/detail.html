<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/public.css"/>
		<link rel="stylesheet" type="text/css" href="../../fonts/font.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/detail/detail.css"/>
	</head>
	<style type="text/css">
		.myCard:nth-child(1){
			margin-top: 0;
		}
		.myCard{
			margin: 10px 0;
		}
		.mui-table-view-cell{
			padding: 11px 0;
		}
		.mui-table-view-cell::after{
			left: 0;
		}
		.mui-bar .mui-icon{
			padding-top: 7px;
		}
		#header .mui-active{
			color: #ff5000;
			border-color: #ff5000;
		}
	</style>
	<body>
	<header id="header" class="mui-bar mui-bar-transparent" style="height: 40px;">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="position: fixed;top: 0px;">
			<a class="mui-control-item mui-active" href="#item1mobile">商品</a>
			<a class="mui-control-item" href="#item2mobile">详情</a>
			<a class="mui-control-item" href="#item3mobile">评价</a>
		</div><!-- #sliderSegmentedControl -->
	</header>
		
	 <div class="mui-content" style="padding-bottom: 50px;">
		 
			<!-- 商品 -->
			<div class="mui-slider-group" style="margin-top: 40px;">
				<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
					<!-- 轮播图 -->
					<div id="slider" class="mui-slider">
						<div class="mui-slider-group mui-slider-loop my-slider-group">
							<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
							<div class="mui-slider-item my-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="../../img/top03.jpg" data-preview-group="1">
								</a>
							</div>
							<!-- 第一张图片 -->
							<div class="mui-slider-item my-slider-item">
								<a href="#"><img src="../../img/top01.jpg" data-preview-group="1"></a>
							</div>
					
							<div class="mui-slider-item  my-slider-item">
								<a href="#"><img src="../../img/top02.jpg" data-preview-group="1"></a>
							</div>
					
							<div class="mui-slider-item  my-slider-item">
								<a href="#"><img src="../../img/top03.jpg"data-preview-group="1"></a>
							</div>
							<!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
							<div class="mui-slider-item my-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="../../img/top01.jpg" data-preview-group="1">
								</a>
							</div>
						</div>
						<!-- 轮播图原点 -->
						<div class="mui-slider-indicator my-slider-indicator">
							<div class="mui-indicator my-indicator mui-active"></div>
							<div class="mui-indicator my-indicator"></div>
							<div class="mui-indicator my-indicator"></div>
						</div>
					</div><!-- .mui-slider轮播图 -->
					<!-- 商品信息 -->
					<div class="main" >
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent" v-for="(item,i) in prd">
									<div class="main_price">
										<ul>
											<li>
												<span style="font-size: 14px;">￥</span><span style="font-size: 16px;">{{item.price|prd_price}}</span>	
											</li>
											<li>
												<span style="font-size: 14px;">￥</span><span style="font-size: 14px;">{{item.originalPrice|prd_price}}</span>	
											</li>
										</ul>
										<div class="number">
											已出售{{item.buy}}件
										</div>
									</div>
									
									<p class="main_title" style="margin-top: 10px;">
										{{item.title}}
									</p>
								</div>
							</div>
						</div><!-- 卡片 -->
						
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent">
									<ul class="mui-table-view">
										<li class="mui-table-view-cell my_cell">
										
											<div class="cell_left">
												发货
											</div>
											<div class="cell_center">
												<span>上海</span><span style="color: #bbb;margin: 0 5px;">|</span><span>快递:0.00</span>
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												月销88
											</div>
										</li>
										<li class="mui-table-view-cell  my_cell">
											
											<div class="cell_left">
												保障
											</div>
											<div class="cell_center">
												假一赔四·上门取退·极速退款·7天无理由退换
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												<i class="mui-icon mui-icon-arrowright"></i>
											</div>
										
										</li>
										
									</ul>
								</div>
							</div>
						</div><!-- 卡片 -->
						
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent">
									<ul class="mui-table-view">
										<li class="mui-table-view-cell my_cell">
										
											<div class="cell_left">
												发货
											</div>
											<div class="cell_center">
												<span>上海</span><span style="color: #bbb;margin: 0 5px;">|</span><span>快递:0.00</span>
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												月销88
											</div>
										</li>
										<li class="mui-table-view-cell  my_cell">
											
											<div class="cell_left">
												保障
											</div>
											<div class="cell_center">
												假一赔四·上门取退·极速退款·7天无理由退换
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												<i class="mui-icon mui-icon-arrowright"></i>
											</div>
										
										</li>
										
									</ul>
								</div>
							</div>
						</div><!-- 卡片 -->
						
					</div><!-- .main -->
				</div><!-- #item1mobile -->
				
				
				<!-- 详情 -->
				<div id="item2mobile" class="mui-slider-item mui-control-content"> 
					详情
				</div>
				
				<!-- 评价 -->
				<div id="item3mobile" class="mui-slider-item mui-control-content">
					评价
				</div>
			</div>
		
		<!-- 底部加入购物车 -->
			<footer class="mui-bar mui-bar-tab my-mui-bar">
				<div class="tableft">
					<a class="mui-tab-item">
						<span class="mui-icon iconfont icon-service"></span>
						<span class="mui-tab-label">客服</span>
					</a>
					<a class="mui-tab-item" @click="joinCollect" :class="{'cellect':collect.isCollect}">
						<span class="mui-icon iconfont" :class="{'icon-lujing':collect.isCollect,'icon-shoucang1':!collect.isCollect}"></span>
						<span class="mui-tab-label">收藏</span>
					</a>
				</div>
				<div class="tabright">
					<button type="button" class="mui-btn" ref="joinCar" @click="joinCar">
						加入购物车
					</button>
					<button type="button" class="mui-btn">
						立即购买
					</button>
				</div>
			</footer>
			
			
			
			<!-- 点击加入购物车或者立即购买时弹出商品的属性供客户选择 -->
			<div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
			    <!-- 可选择菜单 -->
			    <ul class="mui-table-view">
			      <li class="mui-table-view-cell">
			        <a href="#">菜单1</a>
			      </li>
			      <li class="mui-table-view-cell">
			        <a href="#">菜单2</a>
			      </li>
			    </ul>
			    <!-- 取消菜单 -->
			    <ul class="mui-table-view">
			      <li class="mui-table-view-cell">
			        <a href="#sheet1"><b>取消</b></a>
			      </li>
			    </ul>
			</div>
	</div>
	
	</body>
	
	<script src="../../js/mui.js"></script>
	<script src="../../js/vue.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		
		const myVue=new Vue({
			el:".mui-content",
			data:{
				apiUrl:"http://192.168.88.69:3200",
				prd_id:"",  //商品的id
				prd:[],   //根据id查找到的商品
				user_Id:"",   //本地存储的用户id
				// 收藏
				collect:{
					collectData:[],     //收藏的数据
					isCollect:false,   //控制是否收藏样式
				}
				
			},
			filters:{
				// 过滤价格，保留两位小数
				prd_price(num){
					num=Number(num).toFixed(2)
					return num+"元"
				}
			},
			beforeCreate() {
				
			},
			created() {
				this.getPrdId();
				
			},
			mounted() {
				mui.init();
				
			},
			methods:{
				// 页面刚加载时获取商品的id
				// 根据商品id请求数据库获取到商品价格等信息
				// 根据商品id和用户id判断该商品是否已经被此用户收藏
				getPrdId(){
						let self;
						let that=this;
						
						mui.plusReady(function () {
							
							that.user_Id=plus.storage.getItem("account");  //得到本地存储的用户id
							self=plus.webview.currentWebview();
							
							that.prd_id=self.prd_id;// 获取上一个页面传过来的商品id
							ajax(that.prd_id);   //通过商品id请求后台获取到商品价格等信息
							that.findCollect(that.prd_id,that.user_Id)   //通过商品id请求后台查找该商品是否已经被此用户收藏
						})
						// 请求数据库
						function ajax(id){
							mui.ajax(that.apiUrl+"/detail",{
								data:{
									prd_id:id
								},
								type:"POST",
								dataType:"json",
								timeout:10000,//超时时间设置为10秒；  
								success:function(data){
									// that.prd.push(...data.data);
									that.prd=that.prd.concat(data.data);
								},
								error:function(xhr,type,errorThrown){
									mui.toast("数据请求失败,原因"+type);
								}
							})
						}

				},
				
				// 页面刚加载时先根据商品id和用户id查找这个商品是否被此用户收藏
				findCollect(prd_id,user_Id){
					
					let that=this;
					mui.ajax(that.apiUrl+"/findCollect",{
						data:{
							user_id:user_Id,
							prd_id:prd_id,
						},
						type:"post",
						dataType:"json",
						timeout:10000,//超时时间设置为10秒；  
						success:function(data){
							// 后端返回的字段为1表示已收藏，将收藏样式改为实心
							if(data.code=="1"){
								that.collect.isCollect=true;
							}else{
								that.collect.isCollect=false;
							}
						
						},
						error:function(xhr,type,errorThrown){
							mui.toast("数据请求失败,原因"+type);
						}
					})
				},
				
				// 点击收藏根据商品id和用户id加入收藏表中
				joinCollect(){
					let that=this;
					
					let date=new Date().toLocaleString();  //2020/5/12 下午5:49:49
					let newDate=date.split(" ")[0].replace(/\//img,"-")  //2020-5-12
					
					// 如果样式=false,说明没有被收藏过,则将商品信息和用户id存到收藏表中
					if(that.collect.isCollect==false){
						mui.ajax(that.apiUrl+"/addCollect",{
							data:{
								user_id:that.user_Id,   //用户id
								// prd_id:that.prd_id,   //商品id
								// prd_img:that.prd[0].img,  //收藏的商品的主图
								// prd_price:that.prd[0].price,   //商品的价格
								prd:JSON.stringify(that.prd),
								collect_date:newDate,
							},
							type:"post",
							dataType:"json",
							timeout:10000,//超时时间设置为10秒；  
							success:function(data){
								mui.toast("收藏成功");
								that.collect.isCollect=true;  //改变收藏样式
								// 数据库收藏成功改变样式
							},
							error:function(xhr,type,errorThrown){
								mui.toast("收藏失败,原因"+type);
							}
						})
					}else{
						// 如果样式等于=true说明被收藏过，取消收藏
						
						// 取消收藏
						mui.ajax(that.apiUrl+"/cancelCollect",{
							data:{
								user_id:that.user_Id,
								prd_id:that.prd_id
							},
							type:"post",
							dataType:"json",
							timeout:10000,//超时时间设置为10秒；  
							success:function(data){
								that.collect.isCollect=false;  //改变收藏样式
								mui.toast("已取消收藏");
							},
							error:function(xhr,type,errorThrown){
								mui.toast("数据请求失败,原因"+type);
							}
						})
					}
				},
				
				
				// 点击加入购物车弹出商品属性菜单
				joinCar(){
					
				}
			}
		})
	</script>
</html>
