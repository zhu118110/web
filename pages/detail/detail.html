<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/public.css"/>
		<link rel="stylesheet" type="text/css" href="../../fonts/font.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/detail/detail.css"/>
	</head>
	<style type="text/css">
		.myCard:nth-child(1){
			margin-top: 0;
		}
		.myCard{
			margin: 10px 0;
		}
		.mui-table-view-cell{
			padding: 11px 0;
		}
		.mui-table-view-cell.mui-active{
			background-color: inherit;
		}
		.mui-table-view-cell::after{
			left: 0;
		}
		.mui-bar .mui-icon{
			padding-top: 7px;
		}
		#header .mui-active{
			color: #ff5000;
			border-color: #ff5000;
		}
		.selectLi{
			background-color: #ff0000 !important;
			color: #fff;
		}
	</style>
	<body>
	<header id="header" class="mui-bar mui-bar-transparent" style="height: 40px;">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="position: fixed;top: 0px;">
			<a class="mui-control-item mui-active" href="#item1mobile">商品</a>
			<a class="mui-control-item" href="#item2mobile">详情</a>
			<a class="mui-control-item" href="#item3mobile">评价</a>
		</div><!-- #sliderSegmentedControl -->
	</header>
		
	 <div class="mui-content" style="padding-bottom: 50px;">
		 
			<!-- 商品 -->
			<div class="mui-slider-group" style="margin-top: 40px;">
				<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
					<!-- 轮播图 -->
					<div id="slider" class="mui-slider">
						<div class="mui-slider-group mui-slider-loop my-slider-group">
							<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
							<div class="mui-slider-item my-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="../../img/top03.jpg" data-preview-group="1">
								</a>
							</div>
							<!-- 第一张图片 -->
							<div class="mui-slider-item my-slider-item">
								<a href="#"><img src="../../img/top01.jpg" data-preview-group="1"></a>
							</div>
					
							<div class="mui-slider-item  my-slider-item">
								<a href="#"><img src="../../img/top02.jpg" data-preview-group="1"></a>
							</div>
					
							<div class="mui-slider-item  my-slider-item">
								<a href="#"><img src="../../img/top03.jpg"data-preview-group="1"></a>
							</div>
							<!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
							<div class="mui-slider-item my-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="../../img/top01.jpg" data-preview-group="1">
								</a>
							</div>
						</div>
						<!-- 轮播图原点 -->
						<div class="mui-slider-indicator my-slider-indicator">
							<div class="mui-indicator my-indicator mui-active"></div>
							<div class="mui-indicator my-indicator"></div>
							<div class="mui-indicator my-indicator"></div>
						</div>
					</div><!-- .mui-slider轮播图 -->
					<!-- 商品信息 -->
					<div class="main" >
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent" v-for="(item,i) in prd">
									<div class="main_price">
										<ul>
											<li>
												<span style="font-size: 14px;">￥</span><span style="font-size: 16px;">{{item.price|prd_price}}</span>	
											</li>
											<li>
												<span style="font-size: 14px;">￥</span><span style="font-size: 14px;">{{item.originalPrice|prd_price}}</span>	
											</li>
										</ul>
										<div class="number">
											已出售{{item.buy}}件
										</div>
									</div>
									
									<p class="main_title" style="margin-top: 10px;">
										{{item.title}}
									</p>
								</div>
							</div>
						</div><!-- 卡片 -->
						
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent">
									<ul class="mui-table-view">
										<li class="mui-table-view-cell my_cell">
										
											<div class="cell_left">
												发货
											</div>
											<div class="cell_center">
												<span>上海</span><span style="color: #bbb;margin: 0 5px;">|</span><span>快递:0.00</span>
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												月销88
											</div>
										</li>
										<li class="mui-table-view-cell  my_cell">
											
											<div class="cell_left">
												保障
											</div>
											<div class="cell_center">
												假一赔四·上门取退·极速退款·7天无理由退换
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												<i class="mui-icon mui-icon-arrowright"></i>
											</div>
										
										</li>
										
									</ul>
								</div>
							</div>
						</div><!-- 卡片 -->
						
						<div class="mui-card myCard">
							<div class="mui-card-content">
								<div class="mui-card-content-inner myCardContent">
									<ul class="mui-table-view">
										<li class="mui-table-view-cell my_cell">
										
											<div class="cell_left">
												发货
											</div>
											<div class="cell_center">
												<span>上海</span><span style="color: #bbb;margin: 0 5px;">|</span><span>快递:0.00</span>
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												月销88
											</div>
										</li>
										<li class="mui-table-view-cell  my_cell">
											
											<div class="cell_left">
												保障
											</div>
											<div class="cell_center">
												假一赔四·上门取退·极速退款·7天无理由退换
											</div>
											<div class="cell_right">
												<!-- 月销{{prd[0].buy}} -->
												<i class="mui-icon mui-icon-arrowright"></i>
											</div>
										
										</li>
										
									</ul>
								</div>
							</div>
						</div><!-- 卡片 -->
						
					</div><!-- .main -->
				</div><!-- #item1mobile -->
				<!-- 详情 -->
				<div id="item2mobile" class="mui-slider-item mui-control-content"> 
					详情
				</div>
				
				<!-- 评价 -->
				<div id="item3mobile" class="mui-slider-item mui-control-content">
					评价
				</div>
			</div>
		
		<!-- 底部加入购物车 -->
			<footer class="mui-bar mui-bar-tab my-mui-bar">
				<div class="tableft">
					<a class="mui-tab-item">
						<span class="mui-icon iconfont icon-service"></span>
						<span class="mui-tab-label">客服</span>
					</a>
					<a class="mui-tab-item" @click="joinCollect" :class="{'cellect':collect.isCollect}">
						<span class="mui-icon iconfont" :class="{'icon-lujing':collect.isCollect,'icon-shoucang1':!collect.isCollect}"></span>
						<span class="mui-tab-label">收藏</span>
					</a>
				</div>
				<div class="tabright">
					<button type="button" class="mui-btn" ref="joinCar" @click="joinCarBtn">
						加入购物车
					</button>
					<button type="button" class="mui-btn" @click="buyBtn">
						立即购买
					</button>
				</div>
			</footer>
			
			
			
			<!-- 点击加入购物车或者立即购买时弹出商品的属性供客户选择 -->
			<dialog id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
				<div class="popoverBox">
					<!-- 顶部商品图片以及商品价格 -->
					<div class="popoverHeader" v-for="i in prd">
						<div class="popoverHeader_img">
							<img :src="i.img" v-if="i.img">
							<!-- <img src="../../img/0.jpg" v-else> -->
						</div>
						<div class="popoverHeader_choice">
							<p><span>￥</span>{{i.price|prd_price}}</p>
							<p>
								库存:{{i.number}}
							</p>
							<p>
								<span v-for="(attr,index) in showAttr">
									{{attr}};
								</span>
							</p>
						</div>
					</div>
					
					<!-- 中间商品属性 -->
					<div class="mui-scroll-wrapper">
					    <div class="mui-scroll">
					        <div class="popoverColor" v-for="(attr,index) in prdAttr">
					        	<p>
									{{attr.name}}
								</p>
								<ul class="popoverColor_list" >
									<li v-for="(i,ind) in attr.item" @click="selectAttr(index,ind)" :class="{'selectLi':ind == xuantype[index]}">
										
										<span>{{i.attr_val}}</span>
									</li>
								</ul>
					        </div>
							
							<!-- 购买数量 -->
							<div class="popoverBuy_number">
								<span>
									购买数量
								</span>
								<div class="my_numbox">
									<button type="button" class="mui-btn mui-btn-outlined" :disabled="buyNumber<=1" @click="buyNumber-=1">-</button>
									<input type="number":value="buyNumber" readonly="readonly" v-model="buyNumber" @blur="blur"/>
									<button type="button" class="mui-btn mui-btn-outlined" :disabled="buyNumber>=10" @click="buyNumber+=1">+</button>
								</div>
							</div>
							
					    </div><!-- .mui-scroll -->
					</div><!-- .mui-scroll-wrapper -->
					
				</div>
				
			    <!-- 底部确定按钮 -->
				<div class="popover_btn">
					<button type="button" style="width: 100%;" class="mui-btn" @click="dialogBtn">
						确定
					</button>
				</div>
				
			  
			</dialog>
	</div>
	
	</body>
	
	<script src="../../js/mui.js"></script>
	<script src="../../js/vue.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		
		const myVue=new Vue({
			el:".mui-content",
			data:{
				apiUrl:"http://192.168.43.26:3200",
				prd_id:"",  //商品的id
				prd:[],   //根据id查找到的商品
				prdAttr:[],   //根据商品id查找到的商品的属性
				showAttr:[],  //展示选中的属性
				user_Id:"",   //本地存储的用户id
				attr_id:"",   //选中的属性id
				val_id:"",    //选中的属性值的id
				// 收藏
				collect:{
					collectData:[],     //收藏的数据
					isCollect:false,   //控制是否收藏样式
				},
				buyNumber:1,   //购买数量
				xuantype:[],
				btnStyle:false,   //点击加入购物车变为true，点击立即购买变为false
			},
			filters:{
				// 过滤价格，保留两位小数
				prd_price(num){
					num=Number(num).toFixed(2)
					return num+"元"
				}
			},
			created() {
				this.getPrdId();
			},
			mounted() {
				mui.init();
				// mui("#sheet1").popover('show');
				mui('.mui-scroll-wrapper').scroll({
					 scrollY: true, //是否竖向滚动
					 scrollX: false, //是否横向滚动
					 startX: 0, //初始化时滚动至x
					 startY: 0, //初始化时滚动至y
					 indicators: true, //是否显示滚动条
					 deceleration:0.0006, //阻尼系数,系数越小滑动越灵敏
					 bounce: true //是否启用回弹
				})
			},
			methods:{
				// 页面刚加载时获取商品的id
				// 根据商品id请求数据库获取到商品价格等信息
				// 根据商品id和用户id判断该商品是否已经被此用户收藏
				getPrdId(){
						let self;
						let that=this;
						mui.plusReady(function () {
							self=plus.webview.currentWebview();
							that.prd_id=self.prd_id;// 获取上一个页面传过来的商品id
							that.user_Id=self.userId; // 获取上一个页面传过来的用户id
							getAttr(that.prd_id,that.apiUrl+"/getAttr");   //通过商品id请求后台获取到商品属性
							getPrdInfor(that.prd_id,that.apiUrl+"/getPrdInfor")  //通过商品id请求后台获取到商品信息
							that.findCollect(that.prd_id,that.user_Id)   //通过商品id请求后台查找该商品是否已经被此用户收藏
						})
						// getAttr("5eb3bbfa929ffe2036ca8ebb",that.apiUrl+"/getAttr");   //通过商品id请求后台获取到商品属性
						// getPrdInfor("5eb3bbfa929ffe2036ca8ebb",that.apiUrl+"/getPrdInfor")  //通过商品id请求后台获取到商品信息
						// 根据商品的id请求数据库,得到这个商品的属性
						function getAttr(data,url){
							
							that.ajax({prd_id:data},url,"post",function(data){
								that.prdAttr.push(...data.data);
								that.prdAttr.forEach(val=>{
									that.showAttr.push(val.name)
								})
							})
						};
						// 根据商品的id请求数据库,得到这个商品的价格等信息
						function getPrdInfor(data,url){
							that.ajax({prd_id:data},url,"post",function(data){
								that.prd.push(...data.data)
							})
						};

				},
				
				// 点击属性值添加样式
				selectAttr(index,ind){
					console.log(index,ind)
					var color = index == 0 ? ind : this.xuantype[0];
					var size = index == 1 ? ind : this.xuantype[1];
					this.xuantype = [color,size];			
					var selectColor=this.prdAttr[index].item[ind].attr_val;
					this.showAttr[index]=selectColor;   //展示选中的属性名和属性值
					
					this.attr_id=this.prdAttr[index].id;   //属性id 
					this.val_id=this.prdAttr[index].item[ind]._id;   //属性值id
				},
				
				
				// 页面刚加载时先根据商品id和用户id查找这个商品是否被此用户收藏
				findCollect(prd_id,user_Id){
					
					let that=this;
					let data={
						user_id:user_Id,
						prd_id:prd_id,
					}
					that.ajax(data,that.apiUrl+"/findCollect","post",function(data){
						// 后端返回的字段为1表示已收藏，将收藏样式改为实心
						if(data.code=="1"){
							that.collect.isCollect=true;
						}else{
							that.collect.isCollect=false;
						}
					})
				
				},
				
				// 点击收藏根据商品id和用户id加入收藏表中
				joinCollect(){
					let that=this;
					
					let date=new Date().toLocaleString();  //2020/5/12 下午5:49:49
					let newDate=date.split(" ")[0].replace(/\//img,"-")  //2020-5-12
					
					// 如果样式=false,说明没有被收藏过,则将商品信息和用户id存到收藏表中
					if(that.collect.isCollect==false){
						let data={
							user_id:that.user_Id,   //用户id
							prd:JSON.stringify(that.prd),
							collect_date:newDate,
						}
						that.ajax(data,that.apiUrl+"/addCollect","post",function(data){
							// 后端返回1表示收藏成功,刷新收藏页面
							if(data.code=="1"){
								mui.toast("收藏成功");
								that.collect.isCollect=true;  //改变收藏样式
								//刷新收藏页面
								var detailPage = plus.webview.getWebviewById('my_collect.html');
								mui.fire(detailPage,"pageReload",{
									statu:true
								});
							}else{
								mui.toast("收藏失败,稍后再试");
							}
						})

					}else{
						// 如果样式等于=true说明被收藏过，取消收藏
						// 取消收藏后刷新收藏页面
						let data={
								user_id:that.user_Id,
								prd_id:that.prd_id
							}
						that.ajax(data,that.apiUrl+"/cancelCollect","post",function(data){
							
							if(data.code=="1"){
								that.collect.isCollect=false;  //改变收藏样式
								//刷新收藏页面
								var detailPage = plus.webview.getWebviewById('my_collect.html');
								mui.fire(detailPage,"pageReload",{
									statu:true
								});
							}
						
						})
						
					}
				},
				
				
				// 点击加入购物车弹出商品属性菜单
				joinCarBtn(){
					this.btnStyle=true;
					mui("#sheet1").popover('show');
				},
				joinCar(){
						
						let that=this
						// that.prd.push(that.buyNumber,that.showAttr);
						that.prd[0].buyNumber=that.buyNumber;
						that.prd[0].attr=that.showAttr;
					
						let sendData={
							userId:that.user_Id,
							prd:JSON.stringify(that.prd),
						}
						that.ajax(sendData,that.apiUrl+"/joinCar","post",function(data){
							if(data.code=="1"){
								mui("#sheet1").popover('hide');
								// plus.nativeUI.closeWaiting();
								mui.toast("加入购物车成功");
							}else{
								mui.toast("加入购物车失败");
								mui("#sheet1").popover('hide');
								// plus.nativeUI.closeWaiting();
							}
						})
					
				},
				// 点击立即购买按钮，弹出属性框		
				buyBtn(){
					this.btnStyle=false;
					mui("#sheet1").popover('show');
				},
				buy(){
					let that=this;
					
					that.prd.forEach(val=>{
						val.attr=that.showAttr;
						val.buyNumber=that.buyNumber;
						val.totle=that.buyNumber*val.price;
						val.remark="";
					});
					mui.openWindow({
						url:'../buy/buy.html',
						id:'buy.html',
						extras:{
							userId:that.user_Id,
							prd:that.prd,
						}
					});
				},
				
				
				// 点击属性框的确定
				dialogBtn(){
					let flag =true;
					let that=this;
					console.log(that.xuantype)
					that.xuantype.forEach((val,i,arr)=>{
						
						if(that.xuantype.length!==that.prdAttr.length){
							mui.toast("请选择属性");
							flag=false;
							return false;
						}
					});
					// 如果flag=true,表示勾选了属性，可以存入服务器
					if(flag){
						// plus.nativeUI.showWaiting();
						if(that.btnStyle==true){
							that.joinCar();
						}else{
							that.buy()
						}
					}
				},
				
				
				
				
				
				// 封装ajax
				// @params{Object} data:请求后台携带的数据,
				// @params{String} url:后台的地址,
				// @params{String} type:请求类型,
				// @params{Function} success:请求成功的回调函数
				ajax(data,url,type,success){
					mui.ajax(url,{
						data:data,
						type:type,
						dataType:"json",
						timeout:10000,//超时时间设置为10秒；  
						success:success,
						error:function(xhr,type,errorThrown){
							mui.toast("数据请求失败,原因"+type);
						}
					})
				}
				
			}
		})
	</script>
</html>
