<!Doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>关于我</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="../../css/mui.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../css/public.css"/>
	<link rel="stylesheet" type="text/css" href="../../css/aboutMe/aboutMe.css"/>
	<link rel="stylesheet" type="text/css" href="../../fonts/font.css"/>
	<style type="text/css">
		.myCardContent .iconfont{
			position: relative;
		}
		.myCardContent div.iconfont .mui-badge{
			position: absolute;
			top: -15px;
			background-color:inherit;
			color: #fff;
			padding: 2px 5px;
			border: 1px solid #d01c27;
			color: #d01c27;
		}
	</style>
</head>
<body id="body">
<div class="box" ref="box">
	

		<!-- 侧滑导航根容器 -->
	<div class="mui-off-canvas-wrap" ref="wrap" >
		
		  <!-- 侧滑菜单 -->
		  <aside class="mui-off-canvas-left myaside" ref="myaside" id="myaside">
			  <!-- 侧滑头像 -->
			<header class="myaside_header mytx">
				<div style="border-radius: 50%;overflow: hidden;">
					<img class="mui-media-object mui-pull-left" :src="heade_img">
				</div>
				<div class="mui-media-body">
					<p >{{userName}}</p>
				</div>
		    </header>
			<ul class="mui-table-view" id="">
				
				<a href="#" data-url="myInfor/myInfor.html" data-id="myInfor.html">
					<li class="mui-table-view-cell">
						<span>
							编辑资料
						</span>
						<span class="iconfont icon-gerenxinxi"></span>
					</li>
				</a>
				<a href="#" data-url="address/my_address.html" data-id="my_address.html">
					<li class="mui-table-view-cell">
						<span>
							我的收货地址
						</span>
						<span class="iconfont icon-tianjiadizhi"></span>
					</li>
				</a>
			</ul>
			<ul class="mui-table-view">
				<a>
					<li class="mui-table-view-cell">
						<span>
							音效与通知
						</span>
						<span class="iconfont icon-tongzhi"></span>
					</li>
				</a>
				<a>
					<li class="mui-table-view-cell">
						<span>
							设置
						</span>
						<span class="iconfont icon-shezhi"></span>
					</li>
				</a>
				<a>
					<li class="mui-table-view-cell">
						<span>
							关于我们
						</span>
						<span class="iconfont icon-guanyuwomen"></span>
					</li>
				</a>
			</ul>
			<ul class="mui-table-view">
				<span @click="toLogin()">
					<li class="mui-table-view-cell">
						退出登录
					</li>
				</span>
			</ul>
		  </aside>
		  
		  <!-- 主界面开始 -->
		<div class="mui-content mui-inner-wrap" > 
			
			<!-- w我的信息开始 -->
			<div class="my_infor"  @click="dragToggle()">
				<ul class="mui-table-view mui-table-view-chevron">
					<li class="mui-table-view-cell mui-media">
						<a class="mui-navigate-right mytx">
							<div>
								<img class="mui-media-object mui-pull-left" :src="heade_img">
							</div>
							
							<div class="mui-media-body">
								<p style="color: #fff;">{{userName}}</p>
							</div>
						</a>
					</li>
				</ul>
			</div><!-- w我的信息结束 -->
			
				<!-- 我的订单开始 -->
			<div class="mui-card myCard" style="margin-top: 0;">
				<div class="mui-card-header my-card-header">
					<div>
						我的订单
					</div>
					<div>
						<a href="#"> 产看全部订单 > </a> 
					</div>
				</div>
				<div class="mui-card-content" >
					<div class="mui-card-content-inner myCardContent">
						<!-- onclick="tz('#myOrder')" -->
						<ul id="myOrder" ref="myOrder">
							<a href="#" data-url="OrderState/OrderState.html" data-id="OrderState.html" data-wid="all.html">
								<li>
									<div class="iconfont icon-daifukuan"></div>
									<div>待付款</div>
								</li>
							</a>
							<a href="#" data-url="OrderState/OrderState.html" data-id="OrderState.html" data-wid="waitPay.html">
								<li>
									<div class="iconfont icon-daifenxiang"></div>
									<div>待分享</div>
								</li>
							</a>
							<a href="#" data-url="OrderState/OrderState.html" data-id="OrderState.html" data-wid="waitSend.html">
								<li>
									
									<div class="iconfont icon-dengdaifahuo">
										<span class="mui-badge" v-if="waitSendNum">{{waitSendNum}}</span>
									</div>
									<div>待发货</div>
								</li>
							</a>
							<a href="#" data-url="OrderState/OrderState.html" data-id="OrderState.html" data-wid="waitGet.html">
								<li>
									<div class="iconfont icon-dengdaishouhuo">
										
										<span class="mui-badge" v-if="alreadySendNum">{{alreadySendNum}}</span>
									</div>
									<div>待收货</div>
								</li>
							</a>
							<a href="#" data-url="OrderState/OrderState.html" data-id="OrderState.html" data-wid="waitComment.html">
								<li>
									<div class="iconfont icon-daipingjia-copy">
										<span class="mui-badge" v-if="waitComment">{{waitComment}}</span>
									</div>
									<div>待评价</div>
								</li>
							</a>
						</ul>
					</div>
				</div>
				
			</div><!-- 我的订单结束 -->
			
			<!-- 我的收藏开始 -->
			<div class="mui-card myCard mysc" >
				<div class="mui-card-content">
					<div class="mui-card-content-inner myCardContent">
						<ul id="mysc" ref="mysc">
							<a data-url="collect/my_collect.html" data-id="my_collect.html">
								<li>
									<div class="iconfont icon-youhuiquan"></div>
									<div>优惠券</div>
								</li>
							</a>
							<a data-url="collect/my_collect.html" data-id="my_collect.html">
								<li>
									<div class="iconfont icon-shangpinshoucang"></div>
									<div>商品收藏</div>
								</li>
							</a>
							<a data-url="collect/my_collect.html" data-id="my_collect.html">
								<li>
									<div class="iconfont icon-lishiliulan"></div>
									<div>历史浏览</div>
								</li>
							</a>
							<a data-url="collect/my_collect.html" data-id="my_collect.html">
								<li>
									<div class="iconfont icon-tuikuanshouhou"></div>
									<div>退款售后</div>
								</li>
							</a>
							<a data-url="collect/my_collect.html" data-id="my_collect.html">
								<li>
									<div class="iconfont icon-wodepingjia1"></div>
									<div>我的评价</div>
								</li>
							</a>
						</ul>
					</div>
				</div>
			</div><!-- 我的收藏结束-->
			
			<!-- 精选推荐 -->
			<div class="recommend" id="upLoad">
				<p>
					<span class="iconfont icon-tuijian"></span> 精选推荐
				</p>
				<ul class="mui-table-view my-table-view">
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd1.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
							</div>
							
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd2.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
							</div>
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd3.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
							</div>
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd4.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
								
							</div>
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd4.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
								
							</div>
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">
							<img class="" src="../../img/bd4.jpg">
							<div class="mui-media-body">
								<p>2020春夏新款运动裤女装宽松显瘦半袖宅女休闲瘦半袖宅女休闲</p>
								<ul class="price">
									<li>
										<span>￥</span><span>39.9</span>
									</li>
									<li><span>100人付款</span></li>
								</ul>
								
							</div>
						</a>
					</li>
				</ul>
			</div>		
			<div class="mui-off-canvas-backdrop" style="box-shadow: none;"></div>
		</div> <!-- 主界面结束 -->
	</div><!-- 侧滑导航根容器 -->
 
</div>
</body>
<script src="../../js/mui.min.js"></script>
<script src="../../js/vue.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">

	// 阻止主页面滑动触发侧滑导航
	document.querySelector(".mui-inner-wrap").addEventListener("drag",function(){
		  event.stopPropagation();
	})

	const vue=new Vue({
		el:".box",
		data:{
			userId:"",
			api:"http://192.168.88.69:3200",
			userName:"请先登录",
			heade_img:"../../img/0.jpg",
			waitSendNum:null,    //没有发货的数量
			alreadySendNum:null,    //已经发货的数量
			waitComment:null,    //等待评价的数量
			preloadArr:[]
		},
		created() {
			this.getStorage()
		},
		mounted() {
			mui.init({
				keyEventBind: {  
					backbutton: false,  //Boolean(默认true)关闭back按键监听  
					menubutton: false   //Boolean(默认true)关闭menu按键监听  
				}  
			});
			this.listenOtherPage();
			this.myOrder();
			this.myaside();
			this.mysc();
		},
		methods:{
			// 其他页面触发此事件刷新页面
			listenOtherPage(){
				// 监听登录页面的back事件,刷新页面
				window.addEventListener('clearStorage',function(event){
				  var statu = event.detail.statu;   //  true|false
				  let current=plus.webview.currentWebview();
				   current.reload();//页面刷新 
				});
			},
			
			// 获取本地存储的用户id，
			// 请求后台查找到昵称
			getStorage(){
				let idValue;  
				let that=this;
				mui.plusReady(function () {
					
					// 通过key得到存储的用户id，，key必须是字符串
					that.userId=plus.storage.getItem(`account`);
					// ajax(that.userId);
					if(that.userId){
						// 调用封装的ajax,根据用户id获取用户名和头像
						that.ajax({userId:that.userId},that.api+"/aboutMe","post",function(data){
							let dataArr=[];
							dataArr.push(...[data.data])
							dataArr.forEach(val=>{
								that.userName=val.userName;  //用户名
								that.heade_img=val.headImg;   //用户头像
							});
						});
						console.log("用户id"+that.userId)
						//  根据用户id得到未发货的数量, 后端返回1表示响应成功
						that.ajax({userId:that.userId,target:"waitSend"},that.api+"/waitSendData","post",function(data){
							if(data.code=="1"){
								that.waitSendNum=data.num
							}else{
								that.waitSendNum=""
							}
						});
						//  根据用户id得到已发货的数量, 后端返回1表示响应成功
						that.ajax({userId:that.userId,target:"alreadySend"},that.api+"/waitSendData","post",function(data){
							
							if(data.code=="1"){
								that.alreadySendNum=data.num;
							}else{
								that.alreadySendNum="";
							}
						});
					}
				});
			},
			
			// 封装ajax请求
			// @params{Object} dataObj,请求携带的参数格式如:{key:value}
			// @params{String} url, 请求的后台url
			// @params{String} type, 请求方式,如post,get
			// @params{Function} success, 请求成功的回调函数
			ajax(dataObj,url,type,success){
				mui.ajax(url,{
					data:dataObj,
					type:type,
					timeout:10000,
					success:success,
					error:function(xhr,type){
						mui.toast("连接服务器失败")
					}
				})
			},
			
			
			// 点击退出登录跳转到登录页面
			// 清除本地存储的用户id
			toLogin(){
					// console.log("跳到登录页面");
					
					//退出登录时清除本地存储的用户id
					plus.storage.removeItem("account");
					// console.log(this.preloadArr);
					for(var i=0;i<this.preloadArr.length;i++){
						plus.webview.close(this.preloadArr[i])
					}
					
					
					// 跳转到登录页面
					mui.openWindow({
						url:"../login/login.html",
						id:"login.html",
					});
					var mainTab = plus.webview.getWebviewById('HBuilder');
					
				
			},
			
			// 点击顶部我的信息显示侧滑导航，再点击时关闭
			// 判断用户是否登录,如果没有登录侧滑导航不显示，跳转到登录页面
			dragToggle(){
				if(!this.userId){
					// mui(this.$refs.wrap).offCanvas().close();
					mui.openWindow({
						url:"../login/login.html",
						id:"login.html",
					});
				}else{
					mui(this.$refs.wrap).offCanvas().toggle();
				}
			},
			//点击订单相关
			myOrder(){
				let that=this;
				mui(that.$refs.myOrder).on('tap','a',function(){
					let url=this.getAttribute("data-url");
					let id=this.getAttribute("data-id");
					let wid=this.getAttribute("data-wid");
					that.preloadArr.push(id)
					let OrderState=plus.webview.getWebviewById("OrderState.html");
					mui.openWindow({
						url,
						id,
						extras:{
							userId:that.userId,
							wid:wid
						},
						waiting:{
							autoShow:false
						}
					})	
				})
			},
			
			myaside(){
				let that=this;
			
				mui(that.$refs.myaside).on("tap",".mui-table-view a",function(){
					let url=this.getAttribute("data-url");
					let id=this.getAttribute("data-id");
					if(url&&id){
						that.preloadArr.push(id)
						let extras={
							userId:that.userId,
						};
						let prePage=mui.preload({
							url,
							id,
							extras
						});
						prePage.show()
					}
					
				})	
			},
			
			mysc(){
				let that=this;
							
				mui(that.$refs.mysc).on("tap","a",function(){
					let url=this.getAttribute("data-url");
					let id=this.getAttribute("data-id");
					that.preloadArr.push(id)
					let extras={
						userId:that.userId,
					};
					let prePage=mui.preload({
						url,
						id,
						extras
					});
					prePage.show()
				})	
			}
		}
	})
	
</script>
</html>
